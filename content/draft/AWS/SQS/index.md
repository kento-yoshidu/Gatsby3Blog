---
title: "AWS SAAメモ サーバーレス(SQS)"
postdate: "2021-06-24"
update: "2021-06-24"
seriesName: "AWS SAA勉強メモ"
seriesSlug: "AWS"
description: ""
tags: ["AWS", "SAA", "AWS SQS"]
draft: true
---

# AWS SQS

Amazon Simple Queue Serviceの略。

メッセージのキューを提供するサービス。非同期処理を実現できる。サービス同士を**疎結合**に緩くつなぐ。フルマネージドサービス。

キューはKMSで暗号化される。

## 用語の整理

- メッセージ = サービスが送受信するデータ
- キュー = SQS上のメッセージを保持するキュー
- ポーリング = キューを呼び出すこと
- プロデューサー キューにメッセージを入れるサービス
- コンシューマー キューからメッセージを取り出すサービス

## 処理の流れ

1 送信側は、SQSに向けてメッセージを送信する。
2 SQSは送信内容を**requestキュー**として保持する。
3 受信側は、SQSに問い合わせて保存されているrequestキューを取り出す。この取り出す動作を**ポーリング**という。これは受信側の任意のタイミングで行える。
4 受信側がデータを返信するとSQSは**responseキュー**として保持する。
5 送信側も任意のタイミングでSQSからresponseキューをポーリングする。

キューは複数のサーバーに分散して保存されるため障害に強い。

メッセージのサイズは256KBまで。Extended Client Libraryオプションなら2GBまで。

## キューのタイプ

### スタンダートキュー（標準キュー）

SQSはキューはなるべく順番通りに処理する。取り出すときもランダムに取得される。処理の順番は保証されないが、1回以上の配信が行われ確実にメッセージを届けることができる。

1回以上の配信なので、処理が重複可能性がある。

データのバックアップなどに利用。

### FIFOキュー

そのまま。順序が保証される。1回のみの配信。

1秒あたり300トランザクションが上限。

### 遅延キュー

0秒から15秒、キューが発行された直後からコンシューマーから見えなくする。

### 優先度キュー

### デッドレターキュー

正常に処理できなかったキューを蓄積できる。

### キューの識別子

- キューURL
- メッセージID


### ライフサイクル

ポーリングされてもキューはすぐには削除されない。そもそも**SQSはキューの削除を行わず**、一定期間はSQS上に残っている。削除するのはコンシューマである。「可視性タイムアウト」。二重取得を防止するため。非同期なので送受信が上手くいったかを確かめられないため。

デフォルトでは30秒。

## 可視性タイムアウト

ポーリングしたコンシューマー以外から、しばらく見えなくする機能。30秒から12時間。


## キューの保持期間

> SQS は最長メッセージ保持期間を超えるキューに残っているメッセージを自動的に削除します。 デフォルトのメッセージ保持期間は4日間です。設定を変更することで、最大14日まで保持できます。

## メッセージを受け取ったインスタンスが終了した場合

> 可視性タイムアウトが設定されている場合は有効期限内は他のEC2インスタンスでは処理されませんが、有効期限を過ぎれば別のEC2インスタンスでキューが取得されることになります。

> メッセージが受信された直後は、メッセージはキューに残ったままです。他のコンシューマーが同じメッセージを再処理しないように、Amazon SQS は可視性タイムアウトを設定しています。Amazon SQS では、この時間内に他のコンシューマーが同じメッセージを受信したり処理したりすることはできません。メッセージのデフォルトの可視性タイムアウトは 30 秒です。最小値は 0 秒、最大スケールは 12 時間です。


## ポーリング

SQSにキューを貯めておいて、**受信側が**メッセージがあるかを確認し、自分から取得しにいく動作のこと。

### ショートポーリング

キューが空の場合、即座に「空のキュー」が返される。

### ロングポーリング

0秒～20まで待って、それでもキューが空だった場合に空のキューを返す。

https://business.ntt-east.co.jp/content/cloudsolution/column-135.html

https://qiita.com/UpAllNight/items/7c5022661a1eadc8a88a

https://www.fenet.jp/aws/column/aws-beginner/299/

https://www.acrovision.jp/service/aws/?p=2910

https://qiita.com/taka_22/items/718ec340a710bbf5e3d0

https://ya6mablog.com/aws-sqs/



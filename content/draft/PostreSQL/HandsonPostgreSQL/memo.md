バックアップとは、障害に備え、ある時点のデータベースの状態を取得しておく仕組みです。
リストアとは、バックアップしたデータファイルを再配置することです。
リカバリとは、バックアップ時に取得したデータと、その後の変更を記録したログを使用して対象のデータを任意の時点の状態まで復旧することです。

PostgreSQLのバックアップと復旧には以下のような方法があります。

<img src="/mondai3/img/jpg/k34627.jpg">

物理バックアップ：データベース情報を保存したデータファイルを直接使用するバックアップ方法
論理バックアップ：テーブル構造とデータを意識し、SQLファイルやバイナリファイルで表定義やデータを出力するバックアップ方法

ここでは、オンラインで行う物理バックアップについて説明します。

〇オンラインで行う物理バックアップ(PITR：Point In Time Recovery)
PITRとは、ベースバックアップ(データベース全てのバックアップ)と、PostgreSQLの運用中に出たWAL(Write Ahead Logging：データベースへの変更を記録したログ)を使用してデータベースを復旧する手法です。WALはトランザクションログとも呼ばれます。ベースバックアップを取得した後であれば、障害発生の直前に近い任意の時点の状態に回復できます。
PITRで使用するWALはWALファイルに記録され、溜り続けていくと古いものから削除されます。そのため、WALファイルが削除される前に、WALファイルを別の場所に移して保存(アーカイブ)する必要があります。アーカイブされたWALファイルは、WALアーカイブと呼ばれます。
アーカイブの量が大量になると復旧処理に時間がかかるため、ベースバックアップは定期的に取得することが推奨されています。ベースバックアップを再取得した場合、今までのアーカイブは不要となり、廃棄が可能です。

【PITRのイメージ図】
【図を表示】

PITRは以下のような手順で使用します。
1) 事前設定
2) ベースバックアップ
3) リカバリ

■事前設定
WALファイルが削除されないよう、WALアーカイブとして保存する設定を行います。設定するパラメータは「postgresql.conf」ファイルの以下のパラメータです。

【「postgresql.conf」ファイルの主なパラメータ】
【図を表示2】

【各パラメータの補足】
・wal_level
指定できる値は以下の通りです。
　minimal … PostgreSQLの障害発生やシャットダウンからの回復に必要な情報
　replica … minimalの内容＋WALファイルのアーカイブに必要な情報やスタンバイサーバの読み取り専用クエリの情報
　logical … replicaの内容＋ロジカルレプリケーション(指定したデータベースやテーブル等を対象にデータを複製する機能)に必要な情報

※バージョン9.6より前では、replicaの代わりにarchiveとhot_standbyがありました。これらの値を設定すると、内部的にreplicaに置き換えられます。

・archive_mode
指定できる値は以下の通りです。
　on … WALアーカイブを有効にする
　always … アーカイブリカバリやスタンバイモードにおいてWALアーカイブを有効にする
　off … WALアーカイブを無効にする

・archive_command
例に記載されている、%p、%fには以下の値が埋め込まれます。
　%p … アーカイブするWALファイルのパス名
　%f … アーカイブするWALファイルのファイル名

■ベースバックアップ
PostgreSQLは稼働したままで行うことができます。ベースバックアップの取得は、①pg_start_backup()・pg_stop_backup()関数を使用する方法と、②pg_basebackupコマンドを使用する方法の2つがあります。

【PITRのベースバックアップ方法】
①pg_start_backup()・pg_stop_backup()関数を使用する方法
pg_start_backup()・pg_stop_backup()関数は、PostgreSQLにバックアップの開始・終了を通知する関数です。
バックアップの期間を判断し、バックアップ中に作成されたWALのアーカイブも自動で行います。
pg_start_backup()は、上記の処理に加えてチェックポイントの実行も行います。チェックポイントは、データの変更をディスクに反映する処理です。
(※PostgreSQLでは、データの変更時にディスク上のデータを更新せず、共有メモリ上の共有バッファという領域に読み込んだデータを更新します。その後、共有バッファの内容をまとめてディスク上のデータファイルへ書き込むチェックポイントという処理を行うことで、更新時のパフォーマンスを向上させています。)
pg_start_backup()のチェックポイントの実行によって、リカバリ時に適用すべきWALの情報が記録されます。
関数の実行にはスーパーユーザ権限が必要です。

・手順
1) SELECT文でpg_start_backup()関数を呼び出す (例) SELECT pg_start_backup('ラベル名');
2) データベースクラスタ全体の物理バックアップを取得する
3) SELECT文でpg_stop_backup()関数を呼び出す (例) SELECT pg_stop_backup();

[実行例]
【図を表示8】

②pg_basebackupコマンドを使用する方法
pg_basebackupはバージョン9.1で追加された、ベースバックアップを取得するコマンドです。PITRやストリーミングレプリケーション(データベースクラスタ全体を対象にデータを複製する機能)において使用されます。
データベースクラスタ全体のバックアップを取得するので、設定ファイルやテーブルスペース(テーブル空間)もバックアップの対象に含まれます。デフォルトではWALファイルもバックアップ対象となります。
pg_basebackupコマンドを使用する場合は、バックアップの開始と終了を通知する関数の呼び出しが不要となります。また、リモートでも実行が可能です。
コマンドの実行にはスーパーユーザ権限またはREPLICATION権限(あるデータを別のデータベースへ複製するための権限)が必要です。

書式は以下の通りです。

pg_basebackup [オプション]

【主なオプション】
・-D 出力先のパス | --pgdata=出力先のパス ※必須
ベースバックアップの出力先ディレクトリのパスを指定します。出力先のディレクトリは空の必要があります。

・-X s(stream) | --wal-method=s(stream)
バックアップと並行してWALファイルをアーカイブします(ストリーミング)。デフォルト値です。
この方法では、max_wal_sendersパラメータで設定した接続数のうち2つを使用します。

・-X n(none) | --wal-method=n(none)
WALファイルをバックアップ対象に含めません。

・-X f(fetch) | --wal-method=f(fetch)
WALファイルをバックアップの最後に収集します。

・-P | --progress
バックアップ中にバックアップ処理の進行状態を表示します。

[実行例]
【図を表示9】

■リカバリ
障害が発生した場合に行います。手順は以下のとおりです。
1) PostgreSQLを停止し、障害発生時のデータベースクラスタを退避する
2) 取得していたベースバックアップをリストアする
3) リストアしたデータベースクラスタの$PGDATA/pg_wal配下を削除し、1)で退避させておいたデータベースクラスタのpg_walディレクトリ(未アーカイブのWAL)から、$PGDATA/pg_walディレクトリへコピーする
4) リカバリに関する設定ファイルである「recovery.conf」を作成し、$PGDATA配下においてPostgreSQLを起動する

【「recovery.conf」ファイルの主なパラメータ】
・restore_command　※必須
WALアーカイブを取得するためのシェルコマンドを指定します。
(例) 'cp [WALアーカイブの格納先のパス]/%f %p'

・recovery_target_time
どの時間までデータベースをリカバリするか指定します。指定しない場合は最新のWALまでリカバリされます。

・recovery_target_xid
どのトランザクションIDまでデータベースをリカバリするか指定します。指定しない場合は最新のWALまでリカバリされます。

解説

PITRとは、ベースバックアップ(データベース全てのバックアップ)と、PostgreSQLの運用中に出たWAL(Write Ahead Logging：データベースへの変更を記録したログ)を使用してデータベースを復旧する手法です。
ベースバックアップは物理バックアップに分類され、PostgreSQLを稼働したまま行うことができます。
また、PITRで使用するWALはWALファイルに記録され、溜り続けていくと古いものから削除されます。そのため、WALファイルが削除されないよう、WALアーカイブとして保存する設定を行います。

したがって正解は
・オンラインで取得する物理バックアップを使用する
・古いWALファイルが削除されないようにアーカイブとして保存する必要がある
です。

その他の選択肢については以下の通りです。

・指定するリストアポイントによっては、データの整合性が保障されない可能性がある
データの整合性が取れた状態でリカバリされます。

・リストアポイントはデータベース作成時にオプションで指定する
リストアポイントは、「recovery.conf」のrecovery_target_timeパラメータやrecovery_target_xidパラメータで指定します。

・復旧用に「recovery.conf」が自動で作成される
「recovery.conf」は、基本的にユーザが手動で作成しなければなりません。

正解

ロールやテーブルスペースの定義をバックアップできる

解説

pg_dumpコマンドは論理バックアップをデータベース単位で取得する際に使用するコマンドです。
書式は以下の通りです。

pg_dump [接続オプション] [オプション] [データベース名]

バックアップはデータベース単位でしか取得できないため、データベースクラスタ全体に対する、ロールやテーブルスペース(データベースオブジェクトを格納する領域)定義は取得できません。
ロールやテーブルスペースはpg_dumpallコマンドで取得できます。

したがって正解は
・ロールやテーブルスペースの定義をバックアップできる
です。

その他の選択肢については以下の通りです。

・テーブル定義のみをバックアップできる
・データのみをバックアップできる
オプションを指定することで、テーブル定義のみやデータのみのバックアップも可能です。

・バックアップを任意のファイルに出力できる
-fオプションでバックアップを出力するファイル名を指定できます。

・バックアップの形式にバイナリ形式やカスタム形式を指定できる
-Fオプションでバックアップファイルの形式を指定することができます。

正解

pg_dumpコマンドによるバックアップは、バックアップ時のPostgreSQLと比べてリストア先のバージョンが新しい場合もリストアできる

ディレクトリコピーによるバックアップは、バックアップ時のPostgreSQLと比べてリストア先のバージョンが古い場合にリストアできない

解説

PostgreSQLでのバックアップには、物理バックアップと論理バックアップがあります。
物理バックアップは、オフラインでtarやrsyncコマンドによるディレクトリコピーを行う方法や、オンラインでpg_basebackupコマンドを使用する方法などがあります。データベース情報を保存したデータファイルを直接使用するバックアップ方法であり、PostgreSQLのメジャーバージョンが異なる場合はリストアできません。
論理バックアップは、pg_dump、pg_dumpallコマンドを使用します。データのみを取得するため、PostgreSQLのメジャーバージョンが異なる場合でもリストアできます。

したがって正解は
・pg_dumpコマンドによるバックアップは、バックアップ時のPostgreSQLと比べてリストア先のバージョンが新しい場合もリストアできる
・ディレクトリコピーによるバックアップは、バックアップ時のPostgreSQLと比べてリストア先のバージョンが古い場合にリストアできない
です。

その他の選択肢は以下の通りです。

・pg_dumpallコマンドによるバックアップは、バックアップ時のPostgreSQLと比べてリストア先のバージョンが古い場合にリストアできない
pg_dumpallコマンドは論理バックアップを取得するコマンドであり、PostgreSQLのバージョンによるリストアの制限はありません。

・ディレクトリコピーによるバックアップは、バックアップ時のPostgreSQLと比べてリストア先のバージョンが新しい場合もリストアできる
ディレクトリコピーは物理バックアップを取得する方法であり、PostgreSQLのメジャーバージョンが異なる場合はリストアできません。

・pg_basebackupコマンドによるバックアップは、バックアップ時のPostgreSQLとリストア先のバージョンが異なる場合もリストアできる
pg_basebackupコマンドは物理バックアップを取得するコマンドであり、PostgreSQLのメジャーバージョンが異なる場合はリストアできません。

正解

ログファイルをアーカイブして保存する設定が必要である

リカバリ時に「recovery.conf」ファイルを作成する必要がある

解説

PITRは以下のような手順で使用します。
1) 事前設定
2) ベースバックアップ
3) リカバリ
事前設定では「postgresql.conf」ファイルにおいて、ログファイルをアーカイブして保存する設定を行います。また、リカバリ時には「recovery.conf」ファイルを作成して配置します。

したがって正解は
・ログファイルをアーカイブして保存する設定が必要である
・リカバリ時に「recovery.conf」ファイルを作成する必要がある
です。

その他の選択肢については以下の通りです。

・復旧されるポイントは、常に障害の発生直前のポイントとなる
・復旧されるポイントは、常にベースバックアップの取得直後のポイントとなる
「recovery.conf」ファイルにおいて、リカバリポイントを指定することができます。

・バックアップはpg_dumpallコマンドを使用して取得する
PITRで使用するバックアップは物理バックアップであるため、OSコマンドのtarやrsyncコマンド、pg_basebackupコマンドなどを使用します。

正解

ファイル名を指定してCOPYコマンドを実行する場合は、スーパーユーザ権限が必要である

解説

テーブルとファイル間でデータをコピーする方法としては以下の2つがあります。
・psqlのメタコマンドである\copyコマンドを使用する
・SQLのCOPYコマンドを使用する

\copyコマンドは実行に特別な権限を必要としませんが、COPYコマンドでファイルを指定する場合はスーパーユーザ権限が必要になります。

したがって正解は
・ファイル名を指定してCOPYコマンドを実行する場合は、スーパーユーザ権限が必要である
です。

[実行例]
【図を表示】

その他の選択肢については以下のとおりです。

・\copyコマンドを実行する場合はスーパーユーザ権限が必要である
・ファイル名を指定して\copyコマンドを実行する場合は、スーパーユーザ権限が必要である
\copyコマンドの実行には、スーパーユーザ権限は必要ありません。

・COPYコマンドを実行する場合は、いかなる場合でもスーパーユーザ権限が必要である
COPYコマンドでスーパーユーザ権限が必要となるのは、ファイル名を指定したときのみです。

・COPYコマンドを実行する場合は、いかなる場合でもスーパーユーザ権限は必要ない
ファイル名を指定してCOPYコマンドを実行する場合は、スーパーユーザ権限が必要です。

正解

任意の指定したテーブルや、スキーマをバックアップできる

取得するバックアップファイルの形式は、オプションで指定することができる

コマンドの実行が他ユーザのデータベースアクセスを妨げることはない

解説

pg_dumpコマンドは論理バックアップを取得する際に使用するコマンドです。実行は全ユーザで行うことができ、データベースクラスタのデータをデータベース単位でバックアップします。テーブルやスキーマを指定してバックアップすることも可能です。論理バックアップはPostgreSQLサーバを稼働させたまま行うため、バックアップの実行が他ユーザのデータベースアクセスを妨げることはありません。
バックアップファイルの形式は、テキスト形式・カスタム形式(バイナリ形式)・tar形式の3種類あり、オプションで指定できます。

したがって正解は
・任意の指定したテーブルや、スキーマをバックアップできる
・取得するバックアップファイルの形式は、オプションで指定することができる
・コマンドの実行が他ユーザのデータベースアクセスを妨げることはない
です。

その他の選択肢は以下のとおりです。

・コマンドの実行前にPostgreSQLサーバを停止させる必要がある
pg_dumpコマンドで取得される論理バックアップは、PostgreSQLサーバを停止させずに行うことができます。

・コマンドの実行はスーパーユーザで行う必要がある
pg_dumpコマンドの実行に特別な権限は不要です。

正解

delimiterオプションを指定することで区切り文字を変更できる

解説

\copyコマンドは、テーブルとクライアント側のファイル間でデータのコピーを行うpsqlのメタコマンドです。オプションを指定することで区切り文字の指定やCSV形式の使用ができます。また、コマンドの実行に特別な権限は不要です。

したがって正解は
・delimiterオプションを指定することで区切り文字を変更できる
です。

その他の選択肢については以下のとおりです。

・CSV形式のデータの書き込み、読み込みには対応していない
csvオプションを指定することでCSV形式のデータをコピーできます。

・サーバ側のファイルに対してアクセスする
\copyコマンドがアクセスするのはクライアント側のファイルです。

・ネットワークを介さずにテーブルとファイル間のデータのコピーを行う
クライアント側のファイルにアクセスするため、ネットワークを介して処理を行う必要があります。

・コマンドの実行にはスーパーユーザ権限が必要である
\copyコマンドの実行にスーパーユーザ権限は必要ありません。

正解

テーブルスペースなどを格納しているディレクトリがある場合、それらもバックアップする必要がある

解説

OSの標準的なコマンド「tar」「rsync」コマンド等を用いて行う物理バックアップは、データベース情報を保存したデータファイルを直接バックアップする方法です。「postgresql.conf」等の設定ファイルもバックアップ対象に含まれますが、PostgreSQLを停止させた状態で行う必要があります。また、データベースクラスタのディレクトリ以外にテーブルスペース等のデータがある場合は、それらもバックアップに含める必要があります。

したがって正解は
・テーブルスペースなどを格納しているディレクトリがある場合、それらもバックアップする必要がある
です。

その他の選択肢については、以下のとおりです。

・PostgreSQLの稼働中にバックアップを取得することができる
PostgreSQLを停止させて行う必要があります。

・リストア時にはpsqlコマンドやpg_restoreコマンドを使用する
OSの標準的なコマンド「tar」「rsync」コマンド等を用いて行います。

・「postgresql.conf」等の設定ファイルはバックアップ対象に含まれない
設定ファイルもバックアップ対象となります。

・バックアップしたデータはカスタム形式で取得される
バックアップしたデータはカスタム形式(バイナリ形式)ではなく、コピーしたディレクトリファイルの形で取得されます。

正解

デフォルトでは-X streamオプションが指定されるため、WALファイルはバックアップ対象に含まれる

-Pオプションを指定した場合は、コマンド実行時にバックアップ処理の進捗を表示することができる

解説

pg_basebackupはバージョン9.1で追加された、ベースバックアップを取得するコマンドです。
書式は以下の通りです。

pg_basebackup [オプション]

WALファイルのバックアップ方法は、デフォルトで-X s(stream)に指定されています。この方法では、WALファイルをバックアップ対象に含め、バックアップと並行してWALファイルをアーカイブします(ストリーミング)。
また、オプションに-Pを指定すると、バックアップ中にバックアップ処理の進行状態を表示します。

したがって正解は
・デフォルトでは-X streamオプションが指定されるため、WALファイルはバックアップ対象に含まれる
・-Pオプションを指定した場合は、コマンド実行時にバックアップ処理の進捗を表示することができる
です。

その他の選択肢については以下の通りです。

・設定ファイルやテーブルスペースは手動でバックアップする必要がある
pg_basebackupはデータベースクラスタ全体のバックアップを取得するので、設定ファイルやテーブルスペースもバックアップの対象に含まれます。

・-Dオプションで指定したディレクトリが空ではない場合、既存のデータにバックアップデータを上書きする
-Dオプションで指定するディレクトリが空ではない場合、コマンドの実行はエラーとなります。

・ストリーミングレプリケーションでは使用されない
ストリーミングレプリケーション(データベースクラスタ全体を対象にデータを複製する機能)において、プライマリのベースバックアップを取得する際に使用されます。

正解

psql -f db001.bak newdb

解説

テキスト形式のバックアップをリストアする場合は、psqlコマンドを使用します。
書式は以下の通りです。

psql [接続オプション] [オプション] [データベース名]

したがって正解は
・psql -f db001.bak newdb
です。

[実行例]
【図を表示】

その他の選択肢については以下の通りです。

・pg_restore -f db001.bak newdb
テキスト形式以外のバックアップファイルをリストアするコマンドです。

・pg_dumpall newdb -f db001.bak
・pg_dump newdb < db001.bak
pg_dumpall、pg_dumpは、バックアップを取得するコマンドです。

・pg_ctl restore -f db001.bak newdb
このようなコマンドはありません。

正解

\copy sample to sample.txt delimiter as ','

\copy sample to sample.txt delimiter ','

解説

テーブルとファイル間でデータをコピーする方法としては以下の2つがあります。
・psqlのメタコマンドである\copyコマンドを使用する
・SQLのCOPYコマンドを使用する

\copyコマンドはクライアント側のファイルに、COPYコマンドはサーバ側のファイルにアクセスするため、問題文から\copyコマンドを使用することが読み取れます。
書式は以下の通りです。

\copy テーブル名 to {ファイル名 | stdout} [with] [オプション]

テーブルのデータを各行のカラムごとに区切る場合は、delimiter [as] オプションを使用します。

したがって正解は
・\copy sample to sample.txt delimiter as ','
・\copy sample to sample.txt delimiter ','
です。

[実行結果]
<img src="/mondai3/img/jpg/kkkkk34467.jpg">

その他の選択肢については以下のとおりです。

・COPY sample TO '/Users/local/sample.txt' WITH DELIMITER ',';
COPYコマンドでアクセスできるのはサーバ側のファイルです。

・\copy sample to "sample.txt" delimiter as ','
・\copy sample to 'sample.txt' csv
\copyコマンドでファイル名を指定する場合、「"」や「'」は不要です。



### default_transaction_isolation

新しいトランザクションの分離レベルを設定します。

postgres.confの再読み込み、SETコマンドで設定の繁栄が可能です。

READ UNCOMMITED

**コミットされていない**変更を他のトランザクションから参照できます。なお、コミットされていない変更を読み取ってしまうことを**ダーディリード**といいます。

READ COMMITTED

**コミットされた**変更を他のトランザクションから参照できます。postgres.sqlにおけるデフォルトのレベルです。

REPEATABLE READ

## SETコマンドによる設定の変更

**コミットされた追加・変更**を他のトランザクションから参照できます。

セッション内でのみ有効です。切断してしまえば元に戻ります。

## ALTER SYSTEM

サーバのパラメータ値を書き換えます。コマンド実行後、`postgresql.auto.conf`ファイルに内容が書き込まれ、`postgresql.conf`の次回読み込み時に上書きされます。


## システムカタログ



# postgres.conf

initdb実行時に作成されます。

## サーバの動作関係

|パラメータ|内容|デフォルト|
|:--|:--|:--|
|listen_address|Postgresサーバ自身のIPアドレス|localhost|
|log_connections|待ち受けポート番号|5432|
|max_connections|サーバへの最大同時接続数|100|

上記設定は**Postgresサーバの再起動のみ**によって、設定変更が反映されます。
※postgres.confの再読み込みやSETコマンドの実行によって変更されない。


## pg_settingsビュー

pg_settingsはサーバの実行時パラメータを取得できるビューです。
中でもcontextカラムは**パラメータを変更するために必要な動作**が記載されています。

なお、sighupは（sig）
|値|内容|
|:--|:--|
|internal|変更不可。再度サーバを構築する必要がある|
|postmaster|PostgreSQLサーバ起動時にのみ適用|
|sighup|postgresql.confの再読み込み|
|superuser-backend|スーパーユーザが新しいセッションを開始|
|backend|一般ユーザが新しいセッションを開始|
|superuser|スーパーユーザがSETコマンドを実行|
|user|一般ユーザがSETコマンドを実行|


https://sites.google.com/site/kojimemos/home/mysql/toranzakushon/toranzakushon-fen-lireberu

https://www.postgresql.jp/document/12/html/view-pg-settings.html

https://www.kakiro-web.com/postgresql/postgresql-sql-log-system.html

参考

PostgreSQLは、インストール後すぐに起動させて使用することができますが、実際の業務では、パラメータのデフォルト値を用途に合った設定にする必要があります。
設定ファイルはinitdbの実行時に作成され、データベースクラスタに配置されます。PostgreSQLの設定ファイルのうち、PostgreSQL全体の動作を制御する設定ファイルは「postgresql.conf」です。

■postgresql.conf
書式は以下の通りです。パラメータ名の後の、イコール(=)は省略可です。

パラメータ名 = 設定値

[設定方法]
・パラメータは1行に1つずつ設定する
・大文字・小文字の区別はない
・#から行末まではコメントを意味する(#はどこから始まってもよい)
・パラメータの値は、boolean型、整数型、浮動小数点、文字列の4つである
・boolean値はon, off, true, false, yes, no, 1, 0である
・パラメータのデータ型に応じて単位を設定できる
　　メモリの単位：B(バイト), kB(キロバイト), MB(メガバイト), GB(ギガバイト), TB(テラバイト)で(乗数は1024)　kは小文字にする
　　時間の単位：ms(ミリ秒), s(秒), min(分), h(時間), d(日)

設定できる項目は多岐にわたります。
パラメータを変更するには、「postgresql.conf」をテキストエディターで開いて編集し変更します。また、直接ファイルを変更する方法に加え、スーパーユーザや一般ユーザのSETコマンドで変更できるパラメータもあります。
SETコマンドで設定した設定値は、コマンドを実行したセッション(PostgreSQLサーバへの接続)内でのみ有効となります。
変更が反映されるタイミングはパラメータによって違い、「PostgreSQLの起動・再起動(pg_ctl restart)」「設定ファイルの再読み込み(pg_ctl reload)」「スーパーユーザによるSETコマンドの実行」「一般ユーザによるSETコマンドの実行」があります。後方に記載したタイミングで反映可能な場合は、それより前に記載したタイミングでも反映可能です。

各パラメータは適切な値に設定することが推奨されています。特にログ関連のパラメータは、デフォルトでログが出力されない設定になっているため、運用時に利用できるように変更しておくと良いでしょう。

【「postgresql.conf」ファイルの主なパラメータと反映のタイミング】

【各パラメータの詳細】
・listen_addresses
クライアントからの接続要求を受け付けるPostgreSQLサーバ自身のIPアドレスを指定します。データベースクラスタの初期化後も変更することができます。変更した設定値は、PostgreSQLサーバの起動・再起動で反映されます。
デフォルト値のlocalhostは、サーバ自身を表すループバックアドレスです。ループバックアドレスは、サーバが通常ネットワークを通じて提供している機能に、自身で動作する別のソフトウェアからアクセスする場合などに利用します。つまりデフォルト値のままでは、PostgreSQLに接続できるのはPostgreSQLサーバ自身 (で動作する別のソフトウェア) のみとなり、リモートからの接続はできません。
'*'を指定した場合は、すべてのIPアドレスで接続を待ち受けます。

・port
接続を待ち受けるポート番号を設定します。変更した設定値は、PostgreSQLサーバの起動・再起動で反映されます。デフォルト値は5432です。

・max_connections
PostgreSQLに同時に接続が可能である、接続数の最大値を設定します。変更した設定値は、PostgreSQLサーバの起動・再起動で反映されます。デフォルト値は100であり、パラメータの値は整数型です。
設定値を超えるとエラーが発生し、接続が拒否されます。

・search_path
予めスキーマ名を省略されたテーブルを検索するためのパスを設定します。
スキーマとは、多数のデータベースの格納先を、テーブルの目的や所有者に応じて分類する仕組みのことです。なお、スキーマについては「基本的な運用管理作業」と「SQL コマンド」の分野で詳しく解説します。
変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込み、により反映されます。コマンド実行を行ったセッション内であれば、SETコマンドでもパラメータ値の変更が可能です。デフォルト値は'"$user", public'です。

・default_transaction_isolation
新しいトランザクションのデフォルトの分離レベルを設定します。分離レベルとは、他のトランザクションが同時に実行された場合に、どの程度の影響を受けるかを指定する度合いのことです。

設定できる分離レベルは以下の通りです。
　read unccommitted
　read committed
　repeatable read
　serializable

それぞれの分離レベルについては「トランザクションの概念」の分野で詳しく解説します。
変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。コマンド実行を行ったセッション内であれば、SETコマンドでもパラメータ値の変更が可能です。デフォルト値はread committedです。

・client_encoding
クライアントのエンコーディングを設定します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。コマンド実行を行ったセッション内であれば、SETコマンドでもパラメータ値の変更が可能です。デフォルト値は'SQL_ASCII'です。

・log_destination
PostgreSQLサーバのログ出力先を設定します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。

設定できるログの出力先は以下の通りです。
　stderr…サーバログを平文で標準エラー出力に出力
　csvlog…サーバログをCSV形式で標準エラー出力に出力(logging_collectorをonに設定しなければならない)
　syslog…サーバログをsyslogに出力

デフォルト値はstderrです。

・logging_collector
標準エラーをファイルに書き出すかどうかを設定します。変更した設定値は、PostgreSQLサーバの起動・再起動で反映されます。デフォルト値はoffです。

・log_directory
ログファイルを格納するディレクトリを設定します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。デフォルト値はlogです。

・log_connections
クライアント情報をサーバログに出力するかどうかを設定します。onに設定すると、クライアント認証の成功終了など、サーバへの接続試行をログに残します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。コマンド実行を行ったセッション内であれば、スーパーユーザによるSETコマンドでもパラメータ値の変更が可能です。デフォルト値はoffです。

・log_min_messages
サーバログに書き込むログのレベルを設定します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。コマンド実行を行ったセッション内であれば、スーパーユーザによるSETコマンドでもパラメータ値の変更が可能です。デフォルト値はWARNINGです。
それぞれのレベルはその下の全てのレベルを含みます。レベルを低くする程、より少ないメッセージがログに送られます。

設定できるログレベルは下記のとおりです。
　INFO…ユーザから出力を要求された情報
　NOTICE…ユーザにとって役立つ情報
　WARNING…不適切なコマンド使用等に対するユーザへの警告
　ERROR…特定のコマンドを中断させたエラー
　LOG…データベース管理者にとって役立つ、パフォーマンスや内部の処理に関する情報
　FATAL…特定のセッションを中断させたエラー
　PANIC…全てのセッションを中断させた致命的なエラー

・log_filename
サーバログを書き込むファイルのファイル名を設定します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。

・log_line_prefix
サーバログメッセージの行頭に、ユーザ名やデータベース名、日付などの書式文字列を設定します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。デフォルト値は'%m [%p] 'です。%mはミリ秒付き日付時刻、%pはプロセスIDを表します。

・log_statement
サーバログに書き込むSQL文の種類を設定します。変更した設定値は、PostgreSQLサーバの起動・再起動、または「postgresql.conf」の再読み込みにより反映されます。コマンド実行を行ったセッション内であれば、スーパーユーザによるSETコマンドでもパラメータ値の変更が可能です。デフォルト値はnoneです。

設定できる値は以下の通りです。
　none(off) … なし
　ddl…DDL(データ定義言語)に分類される、CREATE、ALTER、DROP文など
　mod…DDL(データ定義言語)に分類される、CREATE、ALTER、DROP文などに加え、データを変更するINSERT、UPDATE、DELETE、TRUNCATE、COPY FROM文など
　all…全てのSQL文(ただし、単純な構文エラーを持つSQL文は出力されない)

■ALTER SYSTEM
バージョン9.4で新機能として追加された、サーバのパラメータ値を変更するSQLコマンドです。「postgresql.conf」ファイルを直接書き換えるのと同じ結果になります。SETコマンドとは別物であり、変更できるパラメータが特定されていたり、変更の反映範囲がセッション内に限られたりすることはありません。実際の処理ではALTER SYSTEMコマンドで設定したパラメータが「postgresql.auto.conf」ファイルに書き込まれ、「postgresql.conf」ファイルの読み込み時に上書きされます。「postgresql.auto.conf」は「postgresql.conf」と同じ形式で、各パラメータの反映タイミングも同じです。
ALTER SYSTEMコマンドはスーパーユーザで実行する必要があります。

書式は以下の通りです。

ALTER SYSTEM SET パラメータ名 TO {設定値 | DEFAULT};
ALTER SYSTEM SET パラメータ名 = {設定値 | DEFAULT};

[実行例]
【図を表示】

「postgresql.auto.conf」ファイルが自動で作成され、ALTER SYSTEMコマンドで設定された値が書き込まれます。
【図を表示2】

■pg_settings
サーバのパラメータ値を取得するビューです。
nameカラムにパラメータ名、settingカラムにパラメータ値が表示されます。
UPDATE文による更新が可能であり、settingカラムの値を変更するとSETコマンドの実行と同じようにパラメータ値が変更されます。ただし、挿入や削除といった操作は行うことができません。

また、contextカラムからはパラメータ値の反映に必要な操作が読み取れます。
主な値は以下の通りです。
　internal … データベースクラスタの構築後は変更できない
　postmaster … PostgreSQLサーバの起動・再起動
　sighup … 「postgresql.conf」の再読み込み
　superuser-backend … スーパーユーザで新しいセッションを開始
　backend … 一般ユーザで新しいセッションを開始
　superuser … スーパーユーザでSETコマンド実行
　user … 一般ユーザでSETコマンド実行

---

PostgreSQLは、インストール後すぐに起動させて使用することができますが、実際の業務では、パラメータのデフォルト値を用途に合った設定にする必要があります。
設定ファイルはinitdbの実行時に作成され、データベースクラスタに配置されます。

PostgreSQLの設定ファイルのうち、クライアントからの接続を制御する設定ファイルは「pg_hba.conf」です。

■pg_hba.conf
クライアント認証はデータベースクラスタ内の、「pg_hba.conf」という設定ファイルで管理されています。hbaとは、host-based authentication: ホストベース認証の略です。
「pg_hba.conf」ファイルへの変更は、ファイルの再読み込み(pg_ctl reload)の実行によって反映されます。

書式は以下の通りです。
local データベース名 ユーザ名 認証方式
host データベース名 ユーザ名 IPアドレス サブネットマスク 認証方式
host データベース名 ユーザ名 CIDRアドレス 認証方式

[設定方法]
・クライアントの設定は1行1つずつ 1つのクライアントは数行にまたがってはならない
・1行のレコードはスペースもしくはタブで区切られた複数のフィールドで構成される
・フィールドの値が空白を含むときは、" "で囲む
・#から行末まではコメントを意味する(#はどこから始まってもよい)

「pg_hba.conf」ファイルの一般的な書式は、1行につき1つのレコードというレコードの集合です。クライアントから接続を受けると、接続方式やクライアントのIPアドレス、接続先のデータベース名、接続に使用するユーザ名などが、「pg_hba.conf」ファイルに記述されたレコードに一致するかどうかを確認します。
クライアント認証の判定はレコードの上から順に行われ、一致していればその行で指定されている方式で認証します。認証ができれば接続が許可され、認証できなければ接続は拒否されます。認証に成功もしくは失敗した場合、次に続くレコードを確認することはありません。
クライアントからの接続と一致する行がない場合は接続を拒否します。

【「pg_hba.conf」ファイルの主な認証方式】
<img src="/mondai3/img/jpg/k34437.jpg">

【「pg_hba.conf」ファイルの各フィールド】
・接続方式
クライアントが認証する接続方式を指定します。
host…TCP/IP接続に対応します。
local…UNIXドメイン接続に対応します。

・データベース名
接続先のデータベース名を指定します。複数を指定する場合はカンマ区切りにします。allは全てのデータベースを指定します。

・ユーザ名
接続に使用するデータベースユーザ名を指定します。複数を指定する場合はカンマ区切りにします。allは全てのユーザを指定します。

・IPアドレスとサブネットマスク
接続方式が「host」の場合に適用されます。クライアントのIPアドレスの範囲です。

(例) 192.168.1.0 255.255.255.0 → IPアドレス 192.168.1.1～192.168.1.254 が該当する
サブネットマスクの255.255.255.0を2進数で表すと11111111.11111111.11111111.00000000となり、先頭から24行目（1の部分）までの値が同じであるIPアドレスを示します。
※192.168.1.0はネットワークアドレス、192.168.1.255はブロードキャストアドレスとして使用されるため、クライアントのIPアドレスとしては使用できません。

・CIDRアドレス
接続方式が「host」の場合に適用されます。クライアントのIPアドレスの範囲です。
IPアドレスとサブネットマスクのマスク長をスラッシュで区切って表記する形式です。サブネットマスクの代替として使用します。

(例) 192.168.1.0/24 → IPアドレス 192.168.1.1～192.168.1.254 が該当する

■クライアント認証の設定例
(例) UNIXドメインからの接続をすべて許可する。
IPアドレス192.168.1.1～192.168.1.254のホストから、ユーザ「test」がデータベース「example」に接続する際は、平文のパスワード認証を行う。
IPアドレス192.168.16.1～192.168.16.254のホストからの接続は常に拒否する。

local all all trust
host example test 192.168.1.0/24 password
host all all 192.168.16.0/24 reject

---

psqlはPostgreSQLに付属する対話型インターフェースです。対話的にコマンドを入力し、SQL文やメタコマンドを実行します。メタコマンドを使用することで、OSコマンドを実行することも可能です。
また、ファイルから入力を読み込むこともできます。スクリプトの記述を簡便化したり、様々なタスクを自動化することが可能です。
データベースのスーパーユーザ・一般ユーザともに、psqlを使用してデータベースに接続することができます。接続先ホストは、IPアドレスやホスト名で指定することができます。

psqlコマンドの書式は以下の通りです。

psql [接続オプション] [オプション] [データベース名[ユーザ名]]

【主な接続オプション】
稼働中のPostgreSQLサーバに接続する際のオプションです。オプションの設定がない場合は、環境変数が使用されますが、環境変数の設定がない場合は、デフォルトの設定になります。
【図を表示7】

なお、接続オプション「-d」は省略できます。例のように、psqlコマンドに現れる最初のオプションのないパラメータはデータベース名とみなされます。
(例)「psql -U exam data1」は、ユーザ名exam、データベース名data1を指定して接続します。

【psqlの主なオプション】
【図を表示3】
指定したファイルの読み込みでは、シェルの出力リダイレクション(<)を使用して「< ファイル名」と記載することもできます。

[実行例]
-lオプションの実行例です。
【図を表示6】

■SQLコマンド
PostgreSQLはpsqlでSQLコマンドが使用できます。
長いSQLコマンドは、複数行に区切って入力でき、SQLコマンドの終了はセミコロン「;」で判別します。
下記の図では、「SELECT * FROM user;」と一文で入力できるところを区切って入力しています。

一般ユーザで接続した場合、psqlのプロンプトは「データベース名=>」と表示されます。下記の図は、一般ユーザ「user」の例です。
【図を表示】

一文の途中である場合、プロンプトのデータベース名の後の文字列は「->」のように、「=」ではなく「-」で表示されます。

スーパーユーザで接続した場合、psqlのプロンプトは「データベース名=#」と表示されます。下記の図は、スーパーユーザ「postgres」の例です。
【図を表示2】

■メタコマンド
PostgreSQLはpsqlでメタコマンドが使用できます。メタコマンドとは、psqlで独自に使用できるコマンドで「\」で始まり、改行で終了します。psql自体を終了するときは「\q」です。
SQLコマンドは複数行に区切って入力できますが、メタコマンドは複数行に区切れません。

---

dropuserコマンドは、PostgreSQLのユーザアカウントを削除します。SQLコマンド「DROP ROLE/DROP USER」(ロールを削除)を実行するのと同じです。
※PostgreSQLにはロールという概念があります。ロールとは複数のユーザをひとつにまとめたグループのことをいいますが、単体のデータベースユーザもロールとして扱われます。

dropuserコマンドの書式は以下の通りです。

dropuser [接続オプション] [オプション] [ユーザ名]

【主な接続オプション】
稼働中のPostgreSQLサーバに接続する際に使用します。接続には、TCP/IPもしくはUNIXドメインによる通信が使えます。

・-U ユーザ名
接続時のデータベースユーザ名を指定します。

・-h ホスト名またはIPアドレス
接続先のホスト名またはIPアドレスを指定します。

・-p ポート名
接続先のポート番号を指定します。デフォルトは5432です。

【dropuserコマンドの主なオプション】
・-i または --interactive
削除前に確認を促すメッセージが表示されるようにします。また、削除するユーザ名をコマンドで指定しない場合、対話的に入力を促されます。

[実行例]
接続オプション-Uで、スーパーユーザのpostgresを指定します。
--interactiveオプションを使用し、削除前に確認を促すメッセージが表示されるように設定しています。
【図を表示】

このコマンドを使用して、PostgreSQLの既存ユーザを削除することができるのは、スーパーユーザとCREATEROLE権限(ユーザを作成する権限)があるユーザのみです。
また、スーパーユーザを削除したい場合は、スーパーユーザとして接続しなければなりません。
なお、データベースやテーブル等のデータベースオブジェクトを所有しているユーザは削除できません。

正解

PostgreSQL固有のテーブルであり、オブジェクト定義の情報が格納されている

解説

システムカタログは、データベースの内部情報を格納したPostgreSQL固有のテーブルを指します。データベースクラスタの管理に関する情報を含むため、情報スキーマより詳細な情報を確認する際に使用します。

したがって正解は
・PostgreSQL固有のテーブルであり、オブジェクト定義の情報が格納されている
です。

その他の選択肢については以下のとおりです。

・より詳しい情報を取得するには情報スキーマを参照する必要がある
情報スキーマより詳細な情報が確認できます。

・SQLの標準規格には当てはまるため、移植性が高い
SQLの標準規格には当てはまりません。

・データベースクラスタの管理に関する情報は含まない
データベースクラスタの管理に関する情報を含みます。

・ユーザが読み取れる状態にするには、変換が必要となる
ユーザが読み取れる形式で出力されるため、特に変換は不要です。

正解

ANALYZE

解説

統計情報を収集して更新するコマンドはANALYZEです。

したがって正解は
・ANALYZE
です。

その他の選択肢については以下のとおりです。

・VACUUM
テーブルのインデックスを含む不要領域を回収するコマンドです。不要領域の回収とは、不要な領域を判別できるようにマークして、その領域を再利用できるようにすることです。

・VACUUM FULL
テーブルのインデックスを含む不要領域を回収し、回収した領域を削除するコマンドです。

・CLUSTER
インデックスを使用して、テーブルのデータを物理的に並び替えるコマンドです。

・REINDEX
インデックスを作り直し、インデックス内に生じた空領域を解消するコマンドです。

正解

データベース管理に関する情報が格納されている

移植性が高いため、全てのリレーショナルデータベースで使用できる

解説

情報スキーマとは、データベースクラスタに関する情報の確認に使用する仕組みです。データベースオブジェクトに関する定義情報を含むスキーマ(テーブルなどのオブジェクトを格納している名前空間)を指します。スーパーユーザに所有される、ビュー(SQL文のSELECT結果を基にして定義する仮想のテーブル)とテーブルのグループであり、SQLの標準規格に当てはまるために移植性が高いという特徴を持ちます。
システムカタログとは異なり、参照に特別な設定や権限は不要です。

したがって正解は
・データベース管理に関する情報が格納されている
・移植性が高いため、全てのリレーショナルデータベースで使用できる
です。
データベース管理に関する情報が格納されているのは、システムカタログです。
また、情報スキーマはSQLの標準規格に当てはまるため、他データベースに移植することができますが、移植できるデータベースには制限があるため、全てのデータベースに移植できるわけではありません。

その他の選択肢は全て正しい説明です。